# 서버배포 #3 - Route53 설정

freenom에서 무료로 구입한(기간은 1년) 도메인을  
EC2의 IP와 매칭시키기위해 Route53을 사용하도록 하자.  

Route53은 도메인 구입(등록대행자)과 도메인네임서버, 두개의 역할을 해준다.  

**하나의 IP에 여러대의 서버를 연결해서 부하를 분산하는 로드밸런싱과**  
**여러대의 서버를 전세계에 분산시켜서 유저에**  
**가까운 서버의 IP를 Route53이 접속자에게 제공해서 접속자가 자신에게 가까운 곳에**   **접속할수 있도록 하는 Cloud Front를**  
**설정해보자**  


- ## 호스팅 영역(Hosted zones) - 도메인 네임서버 세팅, 생성

Route53을 보면 호스팅 영역이라는 항목이 있다.  
이곳에서 도메인과 IP를 매칭하는 작업을 한다.  

도메인을 세팅하려면 도메인의 정보(도메인 네임과 IP 등)를 갖고 있는 네임서버를 운영해야한다.  

직접 컴퓨터를 장만해서 거기에 네임서버를 설치해서 하는 것도 가능하다만 쉽지 않기에  
Route53이라는 서비스가 있는 것이다.  

Route53에서 도메인네임서버를 만드려면  
호스팅 영역 항목에서 해야한다.  

호스팅 영역 생성 버튼을 누르고  
도메인 이름을 기입하고 생성을 누르면  
네임서버가 만들어진다.  

만든 호스팅 영역 세부로 들어가면  
레코드들이 보인다.


- ## 네임서버 등록

만들어진 호스팅 영역 세부로 들어가서  
예를 들어 example.com이 나의 도메인이라고 한다면  
이 도메인이 현재 있는 네임서버(Route53)이 관리하고 있다는 것을 전세계에 알려야한다.  

등록대행자(도메인 네임을 구입한 곳), 나같은 경우에는 Freenom인데  
**(나같은 경우는 도메인네임을 Freenom에서 구입했기 때문에 등록대행자는 Freenom이 된다.**  
**여기서 Route53은 도메인 네임 서버의 역할을 하는 것이다.**  
**절대로 착각해서는 안된다)**  
그 freenom(등록대행자)에게 example.com의 네임서버는  
AWS-Route53에 있는 네임서버입니다. 라고 알려야한다.  
기본적으로 freenom도 등록대행자와 도메인네임서버를 같이하고 있기 때문에  
freenom에서 도메인 네임을 구입하면 자동으로 freenom이 도메인네임서버 역할도 해주는 상태가 되어있다.  

그러면 example.com의 탑레벨 도메인(.com)인 등록소에게 freenom(등록대행자)이  
example.com에 대한 정보를 가지고 있는  
네임서버는 a.iana-servers.net(Route53의 네임서버)입니다. 라고 알려줘야한다.  

이 과정을 하면, 전세계의 사용자들이 example.com에 접속을 시도했을때   
Root네임서버를 통해서  
탑레벨 도메인 관리자의 네임서버를 통해서  
나의 네임서버에 접근이 가능해진다.  

그러면 freenom에 가서 도메인을 선택한 후,  
Manage Domain -> Management Tools -> Nameservers 란에 가서  
Use Custom nameservers(enter below)를 선택 한 후  

Route53의 호스팅영역의, 세부내용으로 가서  
유형 NS라고 쓰여진 레코드의 값을 카피해서  
넣어주면 된다.  

Route53의 디폴트 ns는 4개가 있는데  
이는 네임서버가 하나만 있으면 그 하나가 잘못됬을 경우를 방지하기 위해 여러 곳을 등록하는 것이다.  

즉, 네임서버 4군데에 example.com의 정보를 두는 것이다.  

    ns-32423.awsdns-35.org. 에서 . 을 뺴고  
    ns-32423.awsdns-35.org만 기입하자.  
    나머지 3개도 똑같이 입력해주자.  


이렇게 하면 누군가가 나의 도메인을 조회하게 되면  
탑레벨 도메인 네임서버에서 freenom에 등록한  
도메인 서버에게 나의 도메인을 물어보라고 하는 작업이 완료된 것이다.  

- ## DNS 디버그
도메인 네임서버들이 제대로 작동하고 있는지  
DNS 디버그를 하는 것이 가능하다.  

구글에서 dig web interface를 쳐서 들어가서  
어드레스 부분에 도메인 네임을 입력하고  
옵션에서 보기좋게 colorize output을 표시하고  
**Trace라는 것을 반드시 체크해주도록 하자**  
그 다음에 실행시키면 DNS가 제대로 작동하는지  
trace한 로그를 전부 다 확인할 수 있다.  

- ## 도메인이름과 IP주소 연결  

이 작업 또한 도메인 네임으로 만든 호스팅영역에서 한다.  

호스팅 영역 안으로 들어가서 레코드 생성을 클릭한다.  

**네임서버의 정보 한건 한건을 레코드라고 한다.**  

들어가보면 레코드 이름이 있는데  
example.com 앞에 www를 넣어서 www.example.com를 사용할 수 있고  
입력을 하지 않으면 example.com을 사용할 수 있다.  
두개 다 사용하고 싶으면 레코드를 따로 따로 2개 생성하면 된다.  

    example.com  
    www.example.com  

그리고 레코드 유형(Type)을 보면 기본적으로  
A - IPv4 주소 및 일부 AWS 리소스로 트래픽 라우팅으로 되어 있는데  
이는 IP주소와 도메인이름을 매칭시키려면 A 타입을 고르면 된다.  

용도에 맞게 Type을 고르게 되어 있는데  
예를 들어 IPv6 기반인 IP를 사용하고 있다면  
AAAA 타입을 사용하면 된다.  

현재 생성한 EC2의 IP는 IPv4이지만  
현재 탄력적 IP를 사용하고 있음으로 C

TTL(Seconds)은 Time To Live로, 
유저가 도메인 네임을 조회했을때 항상 도메인 네임서버에 조회를 하면  
그만큼 느려진다.  
그렇기 때문에 도메인 서버 각각이 캐싱이라는 것을 하는데 그 캐싱의 기간이 TTL이다.  
숫자가 클수록 조회가 줄어들기 때문에 훨씬 빠르게 사용할 수 있다.  

하지만 도메인에 대한 정보를 바꾸게 되면  
조회를 늦게 함으로 반영이 느리다.  
즉, 테스트를 할때에는 TTL을 짧게 잡고  
문제가 없다면 TTL을 길게 잡으면 된다.  

- ## Alias(에일리어스=별명)를 이용해서 AWS의 다른 서비스와 연동  

이 작업을 하기 전에 https를 하기 위해 ACM에서 인증서를 받도록 하자  
등록대행자(프리놈)에서 NS 등록이 끝난 상태, 아직 도메인과 IP를 연결시키지 않은 상태에서  
ACM을 사용하자.  

이번에는 Alias라는 레코드타입(?)을 사용해보자  
Route53은 AWS내의 서비스로,  
AWS안의 서비스 중에 서버의 성격을 가지고 있는 것이 있다.  
파일서버인 S3, ELB(EC2에 웹서버를 깔아서 EC2인스턴스의 여러개의 로드밸런싱을 해주는), CloudFront등이 있는데  
이런 서비스를 이용하면 손쉽게 Route53과 연결할 수 있다.  

S3의 같은 경우, 생성할때 웹서버로 이용하는 것에 체크한 후,  
권한 탭에서 퍼블릭 엑세스 - Everyone을 선택하고 엔드포인트를 복사해서  

호스팅 영역으로 돌아와서 세부로 들어온 다음에  
레코드 생성에서 타입을 A로 하고  
별칭에 on으로 하면  
엔드 포인트 선택 셀렉트가 나온다.  
거기서 선택을 해주고 레코드를 생성을 하면 된다.  

Alias는 로드밸런서를 사용할 것임으로 www.example.com이나 example.com이나 전부  
로드밸런서 생성 뒤에 A타입으로 등록해주자.  



- ## django settings 변경

["35.74.38.181", "starscope.ga", "www.starscope.ga"]로 해야할 것 같지만  
장고 공식 문서를 보면, .starscope.ga 만 기입해도  
"starscope.ga", "www.starscope.ga" 두 개 다 인식된다.

```python

ALLOWED_HOSTS = ["35.74.38.181", ".starscope.ga"]

```

- ## Https 설정 - ACM에서 인증서 등록

**가용영역과 서브넷, ALB에 대해 공부하자**

Https를 설정하기 위해 
ACM에서 인증서를 만들자.  

프로비저닝을 선택 한 후,  
도메인이름을 입력한다. 2개 이상이라도 상관 없다.  

그 다음 DNS 검증을 통해 검증을 진행한다.  
DNS 인증은 CNAME 타입으로 새로운 도메인을 등록하면 시간이 지난 뒤 검증이 완료된다.  

그 다음 ALB 인증서를 등록한다.  
EC2에 가서 로드밸런싱 항목을 클릭한다.  
Application Load Balancer 생성을 클릭하고  
로드 밸런서 이름을 적고  
보안그룹은 EC2와 달라도 상관없다.  

- ## 대상그룹 생성

EC2 인스턴스로 대상그룹을 생성한다.  
대상그룹을 생성할 때에는  
대상유형은 인스턴스이므로 인스턴스,  
대상 그룹 이름은 원하는 이름으로 만들고  
프로토콜은 HTTP에 80으로 하자.  
이는 로드밸런서가 대상그룹에 속해있는 인스턴스에 트래픽을 전달할때 HTTP, 80번포트를 이용하겠다는 것이다.  
(이 설정을 하면 EC2 인스턴스의 인바운드도 HTTP, 80번 포트를 열어놔야한다.)

상태검사는 HTTP로 하자.  
상태검사는 로드밸런서가 대상그룹의 인스턴스가 문제가 없는지  
설정해놓은 프로토콜과 지정해놓은 EC2 인스턴스의 상태검사경로를 통해 제대로 작동하는지 확인한다.  
작동하면 상태확인에 healthy를 표시한다.  

- ## 로드밸런싱(ALB)  

HTTPS의 설정을 위해 ALB로 하자.  

로드밸런서의 이름을 설정하고  
네트워크 매핑에서 가용영역은 트래픽 분산을 가용영역(실제 건물,기기)에 하는 것을 설정하는 것임으로 일단 전부다 체크해주자.  

로드 밸런서를 설정 할 때, 로드밸런서와 EC2의 보안그룹은 서로 달라도 된다.  

리스너를 80(HTTP), 443(HTTPS)와 대상그룹은 둘다 생성해둔 EC2인스턴스의, 대상그룹으로 해놓자.
(로드밸런서를 생성한 후, 80번 리스너의 규칙을 443에 리다이렉트되도록 바꿔놓자)


그리고 대상그룹의 상태가 unhealthy일 경우, 호스트(EC2)에서 리슨하지 않기 때문일 수도 있다.  
즉, 응답할 웹서버가 설치되어 있지 않을 수 있다.  
도커가 설치되어 있는 경우, docker run -p 80:80 nginx로 nginx를 설치하고 해보면 healthy로 될 것이다.  


- ## Route53에서 레코드 생성(Alias를 이용해서 도메인네임과 로드밸런서를 연결)

Route53에 돌아가서 호스팅영역에 들어가서  
레코드 생성을 클릭한 후  
타입은 A에, Alias를 선택한 뒤, 로드밸런서를 선택해주자.  
이때 사용할 도메인네임이 example.com와 www.example.com이라면 Alias가 로드밸런서인  
레코드를 2개 생성해주자.  


참조:   
[ACM에서 인증서 등록, 로드밸런싱](https://www.comtec.kr/2021/07/14/aws-dns-ssl/)  
[ALB 쉽게 이해하기](https://aws-hyoh.tistory.com/147)  
[Route53 레코드 추가 및 ALB 설정](https://www.comtec.kr/2021/08/18/route53-%EB%A0%88%EC%BD%94%EB%93%9C-%EC%B6%94%EA%B0%80-%EB%B0%8F-alb-%EC%84%A4%EC%A0%95/)  
[HTTP->HTTPS 리다이렉션](https://medium.com/@yangga0070/aws-%EB%A1%9C%EB%93%9C%EB%B0%B8%EB%9F%B0%EC%84%9C-http-https-%EB%A6%AC%EB%8B%A4%EC%9D%B4%EB%A0%89%EC%85%98-37c1039be0ab)  
[AWS Https 설정 및 접속하기](https://happiestmemories.tistory.com/48)  