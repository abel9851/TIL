## host header injection

host header는 서버의 도메인 네임과 서버가 현재 리스닝 중인 TCP포트를 지정한다.

포트가 지정되지 않는다면 요청받은 서버의 기본 포트를 의미한다.(HTTP URL은 80)

host header는 반드시 하나가 존재해야한다.

웹 서버는 브라우저의 HTTP Request Header에서 host header를 통해 어떤 가상 호스트의 컨텐츠를 서비스 할지 결정한다.

ip를 통해 서버에 왔지만 헤더를 보고 어떤 컨텐츠를 서비스할지 판단하는 것이다.

서버 안에 여러개의 웹 애플리케이션이 있을 수 있으니까말이다.

host header의 목적은 클라이언트가 커뮤니케이션 하길 원하는 백엔드 컴포넌트를 확인하는 것을 돕기 위해서이다.

request에 host header가 없거나 host header가 어떤 방법으로 인해 잘못된 경우, 애플리케이션에 들어온 요청을 라우팅할 때 문제를 야기할 수 있다.

역사적으로 이 모호성은 각 ip주소가 단일 도메인에 대한 컨텐츠만 호스팅하기 때문에 존재하지 않았지만, 요즘은 클라우드 기반 솔루션, 관련 아키텍처의 대부분을 아웃소싱하는 추세가 계속 증가하고 있기 때문에 동일한 IP주소에서 여러 웹사이트와 애플리케이션에 액세스 할 수 있는 것이 일반적이다.

이 접근 방식은 IPv4 주소 고갈로 인해 인기가 높아졌다.

동일한 IP주소를 통해 여러 응용 프로그램에 액세스할 수 있는 경우 이는 가장 일반적으로 다음 시나리오 중 하나의 결과다.

가상호스팅, 중개자를 통한 트래픽 라우팅.

로드 밸런서는 각 리퀘스트가 라우트되어야할 적절한 백엔드를 알기위해 host header가 필요하다.

브라우저가 요청을 보낼 때 대상 URL은 특정 서버의 IP 주소로 확인됩니다. 이 서버는 요청을 수신하면 호스트 헤더를 참조하여 원하는 백엔드를 결정하고 그에 따라 요청을 전달한다.

여기서 문제. 어떻게해서 바이낸스같은, 다른 도메인이 장고에 도착할수 있을까.

그것은 로드밸런서가 ip주소로 온 리퀘스트에 대한 host헤더를 분별하지 않고 있기 때문이다.

(지금 내 지식으로는 상식밖이지만 이렇게 밖에 설명이 안되는듯?)

host header공격은 호스트 헤더의 값을 안전하지 않은 방식으로 다루고 있는 취약한 웹사이트들을 이용하는 공격이다.

만약 서버가 무조건적으로 호스트헤더를 신뢰하면, 그리고 적절하게 호스트헤더를 회피하거나 유효성검사를 하지 않는다면, 공격자는 이 인풋을 서버 사이드의 행동을 조작할수 있는 위험한 페이로드들을 주입하는데 사용할 수 있다.

이것은, 일단 로드 밸런서에 무조건 host header가 도착한다는 구조이기 때문이다.

로드밸런서나, 애플리케이션에서 관리하지 않는다면 이 호스트 헤더를 이용해서 서버의 행동을 조작할수 있게 된다.

Off-the-shelf(기성품) 웹 애플리케이션은 일반적으로 설정파일을 수동적으로 직접 지정하지 않는다면 앱플리케이션 자신이 배포된 도메인이 무엇인지를 모른다.

예를들어 이메일에 포함된 절대경로 URL을 생성하기 위해 현재 도메인을 알아야하는 경우, 호스트헤더에서 도메인 검색에 의존할 경우가 있다.

```html
<a href="https://_SERVER['HOST']/support">Contact support</a>
```

호스트 헤더는 실제로 유저가 제어할 수 있으므로 이 방법은 여러 문제를 유발할 수 있다.

- 웹 캐시 중독
- 특정 기능의 비즈니스 로직 결함
- 라우팅 기반 SSRF
- SQL 주입과 같은 전형적인 서버 측 취약점

이러한 호스트 헤더 취약점은 일반적으로 유저가 헤더를 제어할 수 없다는 잘못된 가정으로 인해 발생한다. 공격자가 Burp Proxy와 같은 도구를 사용하여 이를 쉽게 수정할 수 있음에도 불구하고 이것은 Host header에 대한 무조건적인 신뢰를 생성하고 부적절한 유효성 검증 또는 값의 이스케이프를 초래한다.

호스트 헤더 자체가 더 안전하게 처리되더라도 들어오는 요청을 처리하는 서버의 구성에 따라 다른 헤더를 삽입하여 호스트를 잠재적으로 무시할 수 있다.

**이러한 호스트 헤더 공격을 방지하기 위해 장고에서는 allowed hosts를 설정파일에 제공한다.**

**이 접근방식은 호스트 헤더 주입공격에 대한 노출을 줄인다.**

Reference

[HTTP Host header attacks | Web Security Academy](https://portswigger.net/web-security/host-header)

[가상 호스트(Vritual Host)와 SNI(Server Name Indication)](https://www.lesstif.com/ws/vritual-host-sni-server-name-indication-43843982.html)

[가상 호스팅 그리고 Host 헤더(Virtual Hosting and Host Header)](https://eminentstar.tistory.com/46)

[Password reset poisoning | Web Security Academy](https://portswigger.net/web-security/host-header/exploiting/password-reset-poisoning)
