- # VPC란

[1. 기본 VPC의 구성 요소들](#기본-VPC의-구성-요소들)  

---

**규모가 큰 곳에서는 VPC를 커스터마이징함으로, 꼭 자세히 배워두는 게 좋다.**  

virtual private cloud로, 아마존이 EC2(classic EC2)를 했을 때는 VPC가 없었고  
나중에 2012년 경에 생겼지만, 그때는 VPC를 사용할지, 안사용할지 선택 할 수 있었다.  
그러나 지금은 무존건 VPC를 선택해야한다. 아니, 선택하지 않는 항목따윈 없다   

VPC는 각 AWS 계정마다 논리적으로 나뉘어진 네트워크 환경을 구성하는 것이다.  
나의 계정으로 AWS 리소스(EC2, RDS, S3)들을 생성하면 그 리소스는 default VPC에 속하게 되며  
다른 사람의 계정으로는 나의 VPC을 볼수도, 접근할 수도 없다.  

classic EC2였을때는 이렇게 논리적으로 나뉘어진 네트워크 공간이 아닌,  모두가 한 네트워크에 접속해서   
그곳에 EC2(AWS 리소스)를 생성하는 구조였지만 지금은 모든 계정이 VPC를 가지고 있다.  

EC2를 생성할때 보이는 네트워크라는 항목이 바로 VPC를 설정하는 항목이고  
그 아래에 있는 서브넷은 VPC에 속하는 리소스이다.  
하나의 인스턴스는 무조건 하나의 서브넷에 속해야한다.  
단, 기본값을 사용한다면 기본 VPC에서 인스턴스가 생성될 것이다.  

RDS를 만드는 과정 중 세번째 단계에서도 네트워크를 설정하게 된다.  
자세히 보면 EC2의 네트워크 설정과 아주 비슷한 것을 알 수 있다.  
VPC와 서브넷을 선택해야하고 여기서에서도 하나의 RDS 인스턴스는  
하나의 서브넷에 속해야 한다.  

VPC는 중의적인 이름이다.  
VPC **그 자체가 리소스의 이름이고**, **동시에 버추얼 프라이빗 클라우드를**  
**구축하기 위한 일체의 리소스를 제공하는 서비스의 이름이기도 하다.**  

VPC = VPC 리소스 그자체(격리된 논리적인 네트워크 공간) + VPC를 구성하기 위한 일체의 리소스를 제공하는 서비스


---

- ## 기본 VPC의 구성 요소들

  - [vpc](#vpc)
  - [n 서브넷(n은 사용할 수 있는 가용존의 개수)](#n-서브넷n은-사용할-수-있는-가용존의-개수)
  - [1 라우트 테이블](#1-라우트-테이블)
  - [1 네트워크 ACL](#1-네트워크-ACL)
  - [1 시큐리티 그룹](#1-시큐리티-그룹)
  - [1 인터넷 게이트웨이](#1-인터넷-게이트웨이)
  - [1 DHCP 옵션셋](#1-DHCP-옵션셋)

- ### vpc

VPC는 프라이빗 클라우드를 만드는 데 가장 기본이 되는 리소스다.  
VPC는 논리적인 독립 네트워크를 구성하는 리소스로  
이름과 IPv4 CIDR블록(Classless Inter-Domain Routing)을 필수적으로 가진다.  

ex) 이름 + ip + CIDR 블록? **이해 필요**

CIDR 블록은 IP의 범위를 지정하는 방식이다.  
CIDR 블록은 IP주소와 슬래시(/) 뒤에 따라오는 넷마스크 숫자로 구성되어 있다.  
이 숫자는 IP 범위를 나타낸다.  
이 숫자가 32면 앞에 기술된 IP를 정확히 하나를 가리킨다.  
예를 들어 192.168.0.0/32는 192.168.0.0을 가리킨다.  
범위는 지정된 IP부터 2^(32-n)개가 된다.  예를 들어 
뒤의 숫자가 24라면, 2^(32-24)=256개의 IP 주소를 의미한다.  
정확히 말하자면 192.169.0.0/24는   
192.168.0.0에서 192.168.0.255까지의 IP를 의미한다.
(CIDR을 정확하게 이해하기 위해서는 IP주소의 2진수 표기와  
서브넷 마스크와 같은 개념을 알아야한다.)  

클라우드에서 생성하는 자원들은 기보적으로 특정 네트워크 위에서 생성되며  
이에 접근하기 위한 프라이빗 IP를 가진다.  
이 리소스들은 특정한 VPC 위에서 만들어진다.  
따라서 VPC의 CIDR 범위 안에서 적절한 IP를 할당 받게 된다.  
예를 들어서 192.168.0.0/24 CIDR 블록을 가진 VPC에서  
생성한 EC2 인스턴스는 192.168.0.127이라는 IP를 할당 받을 수 있다.  
물론 VPC의 범위내에서 할당 가능한 IP가 모두 할당되면 더 이상 리소스를 만들 수 없다.  

따라서 적절한 크기의 VPC를 만들어야한다. 하나의 VPC의 최대 크기는 16이다.  
즉. 2^(32-16)=65,536개의 IP를 사용할 수 있다.  


참조:[CIDR 블록](https://www.nakjunizm.com/2020/01/29/Cidr/)


- ### n 서브넷(n은 사용할 수 있는 가용존의 개수)

VPC만 가지고는 아직 아무것도 할 수 없다.  
VPC는 다시 한번 CIDR 블록을 가지는 단위로 나뉘어 진다.  
서브넷은 실제로 리소스가 생성되는 물리적인 공간이 가용존(Available Zone)과 연결된다.  
(192.169.0.0/24 CIDR블록을 가진 VPC에서 다시한번 CIDR 블록을 가진 단위로 나뉜다는 소리다.)  
(그리고 VPC의 범위보다 작아야한다.)
(VPC의 IP 범위가 10.10.0.0부터 10.10.255.255까지일때. 이 서브넷의 IP 범위는 10.10.0.0부터 10.10.0.255까지 사용할 수 있다.)  
( 10.10.1.0/24을 가진 서브넷도 만들 수 있다.)  
(자세한 건 IP범위에 대해 더욱더 공부해야한다.)  

VPC가 논리적인 범위를 의미한다면, 서브넷은 VPC 안에서  
실제로 리소스가 생성될 수 있는 네트워크라고 생각 할 수 있다.  

서브넷의 최대 크기는 VPC의 크기와 같다.  
VPC와 동일한 크기의 서브넷을 하나만 만드는 것도 가능하다.  

서브넷을 만들지 않을 수도 있지만, 이 경우 VPC로 아무것도 할 수 없다.  
일반적으로 사용할 수 있는 가용존을 고려해서  
적절한 크기의 서브넷들을 가용존 수만큼 생성해서 사용한다.  


서브넷의 넷마스크 범위는 16(65535개)에서 28(16개)을 사용할 수 있으며,  
VPC CIDR 블록 범위에 속하는 CIDR블록을 지정할 수 있다.  
하나의 서브넷은 하나의 가용존과 연결된다.  
리전에 따라서 사용가능한 가용존의 갯수는 다르다.  

- ### 1 라우트 테이블

라우트 테이블은 서브넷과 연결되어 있는 리소스다.  
서브넷에서 네트워크를 이용할 때는 이 라우트 테이블을 사용해서 목적지를 찾게 된다.  
라우트 테이블은 서브넷과 연결되어 있지만 VPC를 생성할 떄 만들어지고  
VPC에도 연결되어 있다.  
이 라우트 테이블은 VPC에 속한 서브넷을 만들 때 기본 라우트 테이블로 사용된다.  

하나의 라우트 테이블은 VPC에 속한 다수의 서브넷에서 사용할 수 있다.  

자동 생성되는 라우트 테이블에는 한가지 룰만 정의되어 있다.  
VPC의 CIDR 블록을 목적지로 하는 경우, 타깃이 local인 규칙이다.  

예를 들어 VPC의 CIDR 블록이 172.31.0.0/16일때 이 네트워크 안에서  
목적지가 172.31.0.9./16 범위에 있는 리소스를 찾는다면 VPC 내부에서 찾는다.  
이 규칙은 삭제할 수 없다.  
인터넷에 연결하거나 다른 VPC와 통신하기 위해서는 라우트 테이블에 라우트 규칙을 추가적으로 정의해야만 한다.  


- ### 1 네트워크 ACL, 1 시큐리티 그룹
  

네트워크 ACL(Acess Control List)은 주고(outbound) 받는(inbound) 트래픽을 제어하는 가상 방화벽이다.  
네트워크 ACL은 다수의 서브넷에서 재사용할 수 있다.  
EC2 인스턴스를 사용해보았다면 ACL보다는 시큐리티 그룹에 익숙할 것이다.  
시큐리티 그룹은 인스턴스의 앞단에서 트래픽을 제어하는 가상 방화벽인 반면,  
네트워크 ACL은 서브넷 앞단에서 트래픽을 제어하는 역할을 한다.  
따라서 네트워크 ACL의 규칙을 통과하더라도 시큐리티 그룹의 규칙을 통과하지 못하면  
인스턴스와는 통신하지 못 할 수 있다.   
이 두 가지 리소스를 통해서 안전한 네트워크 환경을 구축할 수 있다.  

- ### 1 인터넷 게이트웨이
VPC는 기본적으로 격리되어 있는 네트워크 환경이다.  
따라서 VPC에서 생성된 리소스들은  
기본적으로 인터넷을 사용할 수 없다.  
인터넷에 연결하기 위해서는 인터넷 게이트웨이가 필요하다.  
라우팅 테이블에 인터넷 게이트웨이를 향하는 적절한 규칙을 추가해주면  
특정 서브넷이 인터넷과 연결된다.  
하지만 서브넷과 인터넷 게이트웨이를 연결하는것만으로는  
인터넷을 사용할 수 없다.  
인터넷을 사용하고자 하는 리소스는 퍼블릭 IP(EC2 인스턴스를 만들고 그 EC2 IP에 도메인을 연결할때의  
그 IP다.)를 가지고 있어야한다.  

- ### 1 DHCP 옵션셋
DHCP옵션셋은 TCP/IP 네트워크상의 호스트로 설정 정보를 전달하는 DHCP 표준이다.  
이 기능을 사용하면 도메인 네임 서버, 도메인 네임, NTP서버, NetBIOS 서버 등의 정보를 설정 할 수 있다.  
일반적으로 VPC 생성시 만들어지는 DHCP 옵션셋을 사용한다.



참조: [AWS - VPC란](https://www.44bits.io/ko/post/understanding_aws_vpc)  
