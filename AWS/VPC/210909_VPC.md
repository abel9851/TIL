- # VPC란

[1. 기본 VPC의 구성 요소들](#기본-VPC의-구성-요소들)  

---

참조:   
[VPC 개념 이해하기](https://medium.com/harrythegreat/aws-%EA%B0%80%EC%9E%A5%EC%89%BD%EA%B2%8C-vpc-%EA%B0%9C%EB%85%90%EC%9E%A1%EA%B8%B0-71eef95a7098)  
[vpc 라우팅 테이블 이해하기](https://aws-hyoh.tistory.com/53)  

**규모가 큰 곳에서는 VPC를 커스터마이징함으로, 꼭 자세히 배워두는 게 좋다.**  

virtual private cloud로, 아마존이 EC2(classic EC2)를 했을 때는 VPC가 없었고  
나중에 2012년 경에 생겼지만, 그때는 VPC를 사용할지, 안사용할지 선택 할 수 있었다.  
그러나 지금은 무존건 VPC를 선택해야한다. 아니, 선택하지 않는 항목따윈 없다   

VPC는 각 AWS 계정마다 논리적으로 나뉘어진 네트워크 환경을 구성하는 것이다.  
나의 계정으로 AWS 리소스(EC2, RDS, S3)들을 생성하면 그 리소스는 default VPC에 속하게 되며  
다른 사람의 계정으로는 나의 VPC을 볼수도, 접근할 수도 없다.  

classic EC2였을때는 이렇게 논리적으로 나뉘어진 네트워크 공간이 아닌,  모두가 한 네트워크에 접속해서   
그곳에 EC2(AWS 리소스)를 생성하는 구조였지만 지금은 모든 계정이 VPC를 가지고 있다.  

EC2를 생성할때 보이는 네트워크라는 항목이 바로 VPC를 설정하는 항목이고  
그 아래에 있는 서브넷은 VPC에 속하는 리소스이다.  
하나의 인스턴스는 무조건 하나의 서브넷에 속해야한다.(서브넷1 - 인스턴스1, 서브넷2 - 인스턴스3 이런식)  
단, 기본값을 사용한다면 기본 VPC에서 인스턴스가 생성될 것이다.  

RDS를 만드는 과정 중 세번째 단계에서도 네트워크를 설정하게 된다.  
자세히 보면 EC2의 네트워크 설정과 아주 비슷한 것을 알 수 있다.  
VPC와 서브넷을 선택해야하고 여기서에서도 하나의 RDS 인스턴스는  
하나의 서브넷에 속해야 한다.  

VPC는 중의적인 이름이다.  
VPC **그 자체가 리소스의 이름이고**, **동시에 버추얼 프라이빗 클라우드를**  
**구축하기 위한 일체의 리소스를 제공하는 서비스의 이름이기도 하다.**  

VPC = VPC 리소스 그자체(격리된 논리적인 네트워크 공간) + VPC를 구성하기 위한 일체의 리소스를 제공하는 서비스


VPC는 아마존 계정마다 격리된 논리적인 네트워크 환경이다.  
VPC 안에는 퍼블릭 서브넷과 프라이빗 서브넷이 있다.  

AWS VPC는 AWS 클라우드에서 다른 가상 네트워크와 논리적으로 분리되어 있다.  
IP주소 범위와 VPC범위를 설정하고 서브넷을 추가하고  
보안그룹을 연결한 다음 라우팅 테이블을 구성한다.  

하나의 VPC는 하나의 리전내에서만 생성이 가능하다.  
하나의 VPC는 여러 개의 가용영역에 걸쳐서 생성될 수 있다. 

---

- ## 기본 VPC의 구성 요소들

  - [vpc](#vpc)
  - [n 서브넷(n은 사용할 수 있는 가용존의 개수)](#n-서브넷n은-사용할-수-있는-가용존의-개수)
  - [1 라우트 테이블](#1-라우트-테이블)
  - [1 네트워크 ACL](#1-네트워크-ACL)
  - [1 시큐리티 그룹](#1-시큐리티-그룹)
  - [1 인터넷 게이트웨이](#1-인터넷-게이트웨이)
  - [1 DHCP 옵션셋](#1-DHCP-옵션셋)

- ### vpc



VPC는 프라이빗 클라우드를 만드는 데 가장 기본이 되는 리소스다.  
VPC는 논리적인 독립 네트워크를 구성하는 리소스로  
이름과 IPv4 CIDR블록(Classless Inter-Domain Routing)을 필수적으로 가진다.  

ex) 이름 + ip + CIDR 블록? **이해 필요**

CIDR 블록은 IP의 범위를 지정하는 방식이다.  
CIDR 블록은 IP주소와 슬래시(/) 뒤에 따라오는 넷마스크 숫자로 구성되어 있다.  
이 숫자는 IP 범위를 나타낸다.  
이 숫자가 32면 앞에 기술된 IP를 정확히 하나를 가리킨다.  
예를 들어 192.168.0.0/32는 192.168.0.0을 가리킨다.  
범위는 지정된 IP부터 2^(32-n)개가 된다.  예를 들어 
뒤의 숫자가 24라면, 2^(32-24)=256개의 IP 주소를 의미한다.  
정확히 말하자면 192.169.0.0/24는   
192.168.0.0에서 192.168.0.255까지의 IP를 의미한다.
(CIDR을 정확하게 이해하기 위해서는 IP주소의 2진수 표기와  
서브넷 마스크와 같은 개념을 알아야한다.)  

클라우드에서 생성하는 자원들은 기보적으로 특정 네트워크 위에서 생성되며  
이에 접근하기 위한 프라이빗 IP를 가진다.  
이 리소스들은 특정한 VPC 위에서 만들어진다.  
따라서 VPC의 CIDR 범위 안에서 적절한 IP를 할당 받게 된다.  
예를 들어서 192.168.0.0/24 CIDR 블록을 가진 VPC에서  
생성한 EC2 인스턴스는 192.168.0.127이라는 IP를 할당 받을 수 있다.  
물론 VPC의 범위내에서 할당 가능한 IP가 모두 할당되면 더 이상 리소스를 만들 수 없다.  

따라서 적절한 크기의 VPC를 만들어야한다. 하나의 VPC의 최대 크기는 16이다.  
즉. 2^(32-16)=65,536개의 IP를 사용할 수 있다.  


참조:[CIDR 블록](https://www.nakjunizm.com/2020/01/29/Cidr/)


- ### n 서브넷(n은 사용할 수 있는 가용존의 개수)

VPC만 가지고는 아직 아무것도 할 수 없다.  
VPC는 다시 한번 CIDR 블록을 가지는 단위로 나뉘어 진다.  
서브넷은 실제로 리소스가 생성되는 물리적인 공간이 가용존(Available Zone)과 연결된다.  
(192.169.0.0/24 CIDR블록을 가진 VPC에서 다시한번 CIDR 블록을 가진 단위로 나뉜다는 소리다.)  
(그리고 VPC의 범위보다 작아야한다.)
(VPC의 IP 범위가 10.10.0.0부터 10.10.255.255까지일때. 이 서브넷의 IP 범위는 10.10.0.0부터 10.10.0.255까지 사용할 수 있다.)  
( 10.10.1.0/24을 가진 서브넷도 만들 수 있다.)  
(자세한 건 IP범위에 대해 더욱더 공부해야한다.)  

VPC가 논리적인 범위를 의미한다면, 서브넷은 VPC 안에서  
실제로 리소스가 생성될 수 있는 네트워크라고 생각 할 수 있다.  

서브넷의 최대 크기는 VPC의 크기와 같다.  
VPC와 동일한 크기의 서브넷을 하나만 만드는 것도 가능하다.  

서브넷을 만들지 않을 수도 있지만, 이 경우 VPC로 아무것도 할 수 없다.  
일반적으로 사용할 수 있는 가용존을 고려해서  
적절한 크기의 서브넷들을 가용존 수만큼 생성해서 사용한다.  


서브넷의 넷마스크 범위는 16(65535개)에서 28(16개)을 사용할 수 있으며,  
VPC CIDR 블록 범위에 속하는 CIDR블록을 지정할 수 있다.  
하나의 서브넷은 하나의 가용존과 연결된다.  
리전에 따라서 사용가능한 가용존의 갯수는 다르다.  

- ### 1 라우트 테이블


일단 패킷은 src mac/ src ip / dst mac / dst ip /payload 식으로 있다.  
그럼 L3인 GW는 dst ip를 기준으로  
내가 정보를 가지고 있는 영역인가를 판단하고  
정보가 있다면(route / connected)  
그 것을 다른 GW나 host(컴퓨터)로 전달하고  
정보가 없다면 GW 기준으로 Default Route가 설정된 다른 Gw로 보낸다.  
즉, 바깥에서 서브넷으로 가는 것은  
GW에서 내부 서브넷을 알고 있어서(connected)  
외부로 유입되는 트래픽을 특정 호스트로 보내주기 때문이다.  

**참조는 반드시 읽어보자 통신에 대해 훨씬 더 자세히 알 수 있다.**  

참조:   
[LAN 통신이야기](https://m.blog.naver.com/goduck2/220111709554)  
[네트워크 전문가 따라잡기 - ARP에 대해](https://cafe.naver.com/neteg/3101)  

라우팅 테이블은 서브넷에서 아웃바운드할때만?  

인바운드의 경우,  
그건 GW에 내부 Subnet을 알고 있어서(Connected), 외부로 유입되는 트래픽을 보내주기 때문이다.  
인바운드의 경우, GW에서 내부 서브넷을 알고 있어서 외부로 유입되는 트래픽을 내부에 특정 호스트로 보내주기 때문이다..  

Destination Target  
10.0.0.0/16 local  
0.0.0.0/0 igw-id  

인->아웃, 아웃->인이건 간에
네트워크에서도 netmask를 작성하는 서브네팅의 개념이 있으면 이해하기 편하다.  
서브넷 마스크가 동일하면 내가 속한 서브넷(L2 Layer)에서 동작하고  
이후에 GW에 전달할 그 외의 서브넷은 GW로 전달한다.  
그리고 그 외의 모든 라우팅(디폴트 라우팅, 0.0.0.0/0)은 어떤 GW로 보낸다.  

라우팅 테이블의 서브넷은 목적지 대역이라고 보면 되고

저기서 타겟을 어디로 보낼지라고 보면 된다.  

특정 패킷이 들어왔을 때 라우팅 테이블에서 그 패킷의 dstip이 속하는 대역을 찾고  
그 것에 설정된 타겟으로 패킷을 보낸다.  
이건 인, 아웃 상관없이 동작하는 방식이다.  
대역을 longest match rule을 따라서 선택된다.  
그리고 인터넷은 여러 라우터들이 연계되어 있고  
그 라우터의 라우팅 테이블을 보고 패킷을 보낸다.  

참조: [longest match rule](https://net-study.club/entry/Routing-%EA%B0%9C%EC%9A%94-2-AS-IGP-EGP-Classful-Classless-Routing-Protocol-Metric-AD-%EA%B2%BD%EB%A1%9C-%EA%B2%B0%EC%A0%95-%EB%B0%A9%EB%B2%95-Longest-Match-Rule#:~:text=%EB%9D%BC%EC%9A%B0%ED%84%B0%EA%B0%80%20%ED%8C%A8%ED%82%B7%EB%93%A4%EC%9D%84%20%EB%9D%BC%EC%9A%B0%ED%8C%85,Longest%20Match%20Rule)

라우트 테이블은 서브넷과 연결되어 있는 리소스다.  
서브넷에서 네트워크를 이용할 때는 이 라우트 테이블을 사용해서 목적지를 찾게 된다.  
라우트 테이블은 서브넷과 연결되어 있지만 VPC를 생성할 떄 만들어지고  
VPC에도 연결되어 있다.  
이 라우트 테이블은 VPC에 속한 서브넷을 만들 때 기본 라우트 테이블로 사용된다.  

하나의 라우트 테이블은 VPC에 속한 다수의 서브넷에서 사용할 수 있다.  

자동 생성되는 라우트 테이블에는 한가지 룰만 정의되어 있다.  
VPC의 CIDR 블록을 목적지로 하는 경우, 타깃이 local인 규칙이다.  

예를 들어 VPC의 CIDR 블록이 172.31.0.0/16일때 이 네트워크 안에서  
목적지가 172.31.0.9./16 범위에 있는 리소스를 찾는다면 VPC 내부에서 찾는다.  
이 규칙은 삭제할 수 없다.  
인터넷에 연결하거나 다른 VPC와 통신하기 위해서는 라우트 테이블에 라우트 규칙을 추가적으로 정의해야만 한다.  


참조:[AWS- 아웃바운드 라우팅 테이블](https://docs.aws.amazon.com/ko_kr/vpc/latest/tgw/transit-gateway-nat-igw.html)  

- ### 1 네트워크 ACL, 1 시큐리티 그룹
  

네트워크 ACL(Acess Control List)은 주고(outbound) 받는(inbound) 트래픽을 제어하는 가상 방화벽이다.  
네트워크 ACL은 다수의 서브넷에서 재사용할 수 있다.  
EC2 인스턴스를 사용해보았다면 ACL보다는 시큐리티 그룹에 익숙할 것이다.  
시큐리티 그룹은 인스턴스의 앞단에서 트래픽을 제어하는 가상 방화벽인 반면,  
네트워크 ACL은 서브넷 앞단에서 트래픽을 제어하는 역할을 한다.  
따라서 네트워크 ACL의 규칙을 통과하더라도 시큐리티 그룹의 규칙을 통과하지 못하면  
인스턴스와는 통신하지 못 할 수 있다.   
이 두 가지 리소스를 통해서 안전한 네트워크 환경을 구축할 수 있다.  

- ### 1 인터넷 게이트웨이
VPC는 기본적으로 격리되어 있는 네트워크 환경이다.  
따라서 VPC에서 생성된 리소스들은  
기본적으로 인터넷을 사용할 수 없다.  
인터넷에 연결하기 위해서는 인터넷 게이트웨이가 필요하다.  
라우팅 테이블에 인터넷 게이트웨이를 향하는 적절한 규칙을 추가해주면  
특정 서브넷이 인터넷과 연결된다.  
하지만 서브넷과 인터넷 게이트웨이를 연결하는것만으로는  
인터넷을 사용할 수 없다.  
인터넷을 사용하고자 하는 리소스는 퍼블릭 IP(EC2 인스턴스를 만들고 그 EC2 IP에 도메인을 연결할때의  
그 IP다.)를 가지고 있어야한다.  

- ### 1 DHCP 옵션셋
DHCP옵션셋은 TCP/IP 네트워크상의 호스트로 설정 정보를 전달하는 DHCP 표준이다.  
이 기능을 사용하면 도메인 네임 서버, 도메인 네임, NTP서버, NetBIOS 서버 등의 정보를 설정 할 수 있다.  
일반적으로 VPC 생성시 만들어지는 DHCP 옵션셋을 사용한다.



참조: [AWS - VPC란](https://www.44bits.io/ko/post/understanding_aws_vpc)  
